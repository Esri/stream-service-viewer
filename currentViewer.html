<!DOCTYPE html>
<html>
  <head lang="en">
    <meta charset="UTF-8" />
    <title>Stream Service Viewer</title>
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.25/esri/themes/light/main.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://js.arcgis.com/calcite-components/1.0.0-beta.97/calcite.css"
    />
    <link rel="stylesheet" href="./streamServiceViewerStyles.css" />
    <script src="https://js.arcgis.com/4.25/"></script>
    <script src="https://use.fontawesome.com/9482a0b1d1.js"></script>
    <script
      type="module"
      src="https://js.arcgis.com/calcite-components/1.0.0-beta.97/calcite.esm.js"
    ></script>
    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/widgets/BasemapGallery",
        "esri/layers/StreamLayer",
        "esri/geometry/Polygon",
        "esri/Graphic",
        "esri/PopupTemplate",
        "esri/popup/FieldInfo",
        "esri/widgets/Sketch/SketchViewModel",
        "esri/layers/GraphicsLayer",
        "esri/widgets/Expand"
      ], function(
        Map,
        MapView,
        BasemapGallery,
        StreamLayer,
        Polygon,
        Graphic,
        PopupTemplate,
        FieldInfo,
        SketchViewModel,
        GraphicsLayer,
        Expand
      ) {
        var map,
          mapView,
          sketchViewModel,
          sketchViewModelLayer,
          streamLayer,
          spatialFilter,
          expressionFilter;

        function init() {
          map = new Map({
            basemap: "gray-vector"
          });

          mapView = new MapView({
            map: map,
            container: "map"
          });

          var bgExpand = new Expand({
            view: mapView,
            content: new BasemapGallery({ view: mapView })
          });
          mapView.ui.add(bgExpand, "top-left");

          sketchViewModelLayer = new GraphicsLayer();
          map.add(sketchViewModelLayer);

          sketchViewModel = new SketchViewModel({
            layer: sketchViewModelLayer,
            view: mapView,
            defaultUpdateOptions: {
              enableRotation: false,
              toggleToolOnClick: false
            }
          });

          sketchViewModel.on("create", function(obj) {
            switch (obj.state) {
              case "complete":
                spatialFilter = obj.graphic.geometry.extent;
                drawSpatialFilter(spatialFilter);
                if (streamLayer) streamLayer.geometryDefinition = spatialFilter;
                document
                  .getElementById("clearSpatialFilter")
                  .removeAttribute("disabled");
                break;
              default:
                break;
            }
          });

          //connect click events to UI buttons
          var headerElements = document.getElementsByClassName("config-header");
          for (var i = 0; i < headerElements.length; i++) {
            headerElements[i].addEventListener("click", function(e) {
              if (e.target.type !== "checkbox") {
                var sectionWrapper = e.target.closest("section");
                sectionWrapper.classList.toggle("section-hidden");
              }
            });
          }
          document
            .getElementsByClassName("collapser")[0]
            .addEventListener("click", togglePanel);
          document
            .getElementById("toggleStreamLayer")
            .addEventListener("click", toggleStreamLayer);
          document
            .getElementById("applyWhereClause")
            .addEventListener("click", applyWhereClause);
          document
            .getElementById("applySpatialFilter")
            .addEventListener("click", applySpatialFilter);
          document
            .getElementById("clearSpatialFilter")
            .addEventListener("click", clearSpatialFilter);
          document
            .getElementById("switchViewer")
            .addEventListener("click", function() {
              window.location.href = "./classicViewer.html";
            });
        }

        /*************************************************
         *
         * Functions to update the UI
         *
         *************************************************/
        function togglePanel() {
          document
            .getElementsByTagName("body")[0]
            .classList.toggle("panel-collapsed");
        }

        function createToaster(title, message, color) {
          var calciteAlert = document.createElement("calcite-alert");
          var alertTitle = document.createElement("div");
          var alertMessage = document.createElement("div");

          calciteAlert.setAttribute("open", "true");
          calciteAlert.setAttribute("color", color);
          calciteAlert.setAttribute("placement", "bottom-end");
          alertTitle.setAttribute("slot", "title");
          alertMessage.setAttribute("slot", "message");

          alertTitle.innerText = title;
          alertMessage.innerText = message;

          calciteAlert.appendChild(alertTitle);
          calciteAlert.appendChild(alertMessage);
          document.getElementsByTagName("body")[0].appendChild(calciteAlert);
        }

        /*************************************************
         *
         * Functions to add and remove Stream Layer
         *
         *************************************************/
        function toggleStreamLayer() {
          streamLayer ? removeStreamLayer() : addStreamLayer();
        }

        function addStreamLayer() {
          //url to stream service
          var svcUrl = document.getElementById("streamServiceUrl").value;

          //construct Stream Layer
          streamLayer = new StreamLayer({
            url: svcUrl,
            definitionExpression: expressionFilter,
            geometryDefinition: spatialFilter,
            purgeOptions: { displayCount: 10000 }
          });

          streamLayer.createPopupTemplate();

          //Add layer to map
          map.add(streamLayer);

          //When layer loads, register listeners for layer events and add layer to map
          mapView.whenLayerView(streamLayer).then(function (layerView) {
            onLayerAdded();

            layerView.watch("connectionStatus", function (value) {
              if (value === "connected") {
                onLayerAdded();
              } else {
                onLayerRemoved();
              }
            });
            layerView.watch("connectionError", function (error) {
              createToaster(
                "Alert",
                "Error connecting to the Stream Service",
                "red"
              );
              removeStreamLayer();
            });

            streamLayer.popupTemplate = streamLayer.createPopupTemplate();
          });
        }

        function removeStreamLayer() {
          if (streamLayer) {
            map.remove(streamLayer);
            streamLayer.destroy();
            streamLayer = null;
            onLayerRemoved();
          }
        }

        /*********************************************************
         *
         * Stream layer event handlers
         *
         *********************************************************/
        function onLayerAdded() {
          document.getElementById("toggleStreamLayer").innerText =
            "Remove Stream Layer";
          document
            .getElementById("subscribeUnsubscribe")
            .removeAttribute("disabled");
          document
            .getElementById("clearPreviousObservations")
            .removeAttribute("disabled");
          // disable buttons as we can't change stuff on the fly
          document
            .getElementById("applySpatialFilter")
            .setAttribute("disabled", "true");
          document
            .getElementById("clearSpatialFilter")
            .setAttribute("disabled", "true");
          document
            .getElementById("applyWhereClause")
            .setAttribute("disabled", "true");
        }

        function onLayerRemoved() {
          document.getElementById("toggleStreamLayer").innerText =
            "Add Stream Layer";
          document
            .getElementById("subscribeUnsubscribe")
            .setAttribute("disabled", "true");
          document
            .getElementById("clearPreviousObservations")
            .setAttribute("disabled", "true");
          // enable necessary buttons
          if (spatialFilter)
            document
              .getElementById("clearSpatialFilter")
              .removeAttribute("disabled");
          document
            .getElementById("applySpatialFilter")
            .removeAttribute("disabled");
          document
            .getElementById("applyWhereClause")
            .removeAttribute("disabled");
        }

        function onMessage(msg) {
          if (msg.error) {
            createToaster("Alert", msg.error[0], "red");
          } else if (msg.filter) {
            if (
              msg.filter.hasOwnProperty("where") ||
              msg.filter.hasOwnProperty("geometry")
            ) {
              createToaster(
                "Success",
                "Successfully updated the filter. \nAttribute Filter: " +
                  (msg.filter.where || "") +
                  "\nSpatial Filter: " +
                  (msg.filter.geometry
                    ? typeof msg.filter.geometry === "object"
                      ? JSON.stringify(msg.filter.geometry)
                      : msg.filter.geometry
                    : ""),
                "green"
              );
            } else {
              createToaster(
                "Success",
                "Successfully updated the filter. \n\nAttribute Filter: \n Spatial Filter: ",
                "green"
              );
            }
          }
        }

        /************************************************
         *
         * Functions to set and clear spatial/expression filter
         *
         ************************************************/
        function applyWhereClause() {
          expressionFilter = document.getElementById("expressionFilter").value;
          if (streamLayer)
            streamLayer.definitionExpression = expressionFilter || null;
        }

        function applySpatialFilter() {
          sketchViewModel.create("rectangle");
        }

        function clearSpatialFilter() {
          spatialFilter = null;
          sketchViewModelLayer.removeAll();
          if (streamLayer) streamLayer.geometryDefinition = null;
          document
            .getElementById("clearSpatialFilter")
            .setAttribute("disabled", "true");
        }

        function drawSpatialFilter(geometry) {
          //update map graphic to show current spatial filter
          if (geometry) {
            sketchViewModelLayer.removeAll();
            sketchViewModelLayer.add(
              new Graphic({
                geometry: geometry,
                symbol: {
                  type: "simple-fill",
                  style: "none",
                  outline: {
                    color: [5, 112, 176],
                    width: 2
                  }
                }
              })
            );
          }
        }

        init();
      });
    </script>
  </head>

  <body class="flat">
    <div id="map"></div>
    <div class="collapser">
      <i id="collapserIcon" class="flat-chevron-right"></i>
      <i id="expanderIcon" class="flat-chevron-left"></i>
    </div>
    <div id="controls">
      <section>
        <div class="config-header">
          <h2>Layers</h2>
          <div class="header-actions-group">
            <i class="fa"></i>
          </div>
        </div>
        <div class="config-content">
          <div class="input-group input-group-full">
            <calcite-input
              type="text"
              id="streamServiceUrl"
              placeholder="Stream layer url"
              value="https://geoeventsample1.esri.com/server/rest/services/FAAStream/StreamServer"
            ></calcite-input>
          </div>
          <div class="input-group input-group-full">
            <calcite-button id="toggleStreamLayer" width="full"
              >Add Stream Layer</calcite-button
            >
          </div>
          <div class="input-group input-group-full">
            <calcite-tooltip
              label="This feature is currently unavailable with the current version of the JSAPI"
              reference-element="subscribeUnsubscribe"
            >
              <span
                >This feature is currently unavailable with the current version
                of the JSAPI</span
              >
            </calcite-tooltip>
            <calcite-button
              id="subscribeUnsubscribe"
              width="full"
              disabled="true"
              >Unsubscribe</calcite-button
            >
          </div>
          <div class="input-group input-group-full">
            <calcite-tooltip
              label="This feature is currently unavailable with the current version of the JSAPI"
              reference-element="clearPreviousObservations"
            >
              <span
                >This feature is currently unavailable with the current version
                of the JSAPI</span
              >
            </calcite-tooltip>
            <calcite-button
              id="clearPreviousObservations"
              width="full"
              disabled="true"
              >Clear Previous Observations</calcite-button
            >
          </div>
          <div class="input-group input-group-full">
            <calcite-input
              id="expressionFilter"
              type="text"
              placeholder="Attribute Filter (where clause)"
            >
              <calcite-button id="applyWhereClause" slot="action"
                >Apply</calcite-button
              >
            </calcite-input>
          </div>
          <div class="input-group">
            <div class="input-row">
              <calcite-button id="applySpatialFilter" class="prev-element"
                >Apply Spatial Filter</calcite-button
              >
              <calcite-button id="clearSpatialFilter" disabled="true"
                >Clear Spatial Filter</calcite-button
              >
            </div>
          </div>
        </div>
      </section>
      <calcite-button
        id="switchViewer"
        style="position: absolute; bottom: 0; right: 0; z-index: 1; margin: 5px;"
        >Switch to Classic Viewer</calcite-button
      >
    </div>
  </body>
</html>
